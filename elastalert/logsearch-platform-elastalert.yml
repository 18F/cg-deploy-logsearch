instance_groups:
- name: maintenance
  jobs:
  - name: elastalert
    release: elastalert
    # if niled out, will use the specified elastic host instead, which is our collocated instance
    # That instance will use disco to find the right master instead of defaulting to a given index
    consumes:
      elasticsearch: nil
    properties:
      elastalert:
        elasticsearch:
          host: 127.0.0.1
          port: 9200
        run_every:
          minutes: 5
        buffer_time:
          minutes: 60
        alert_time_limit:
          days: 1
        rules:
          common:
            alert:
            - pagerduty
            pagerduty_service_key: (( param "set pagerduty service key" ))
            pagerduty_client_name: elastalert via cg-deploy-logsearch
          rules:
          - name: snort
            content:
              name: snort-alert
              type: any
              index: logs-platform-*
              query_key:
              - "@source.host"
              - "sid"
              - "rev"
              - "syslog_sd_params.deployment"
              - "syslog_sd_params.group"
              - "syslog_sd_params.id"
              realert:
                hours: 1
              alert_subject: "Snort alert on {0}:{1}/{2} (IP: {3}). sid:{4}; rev:{5}"
              alert_subject_args:
              - "syslog_sd_params.deployment"
              - "syslog_sd_params.group"
              - "syslog_sd_params.id"
              - "@source.host"
              - "sid"
              - "rev"
              alert_text: "{0}"
              alert_text_args:
              - "@message"
              pagerduty_incident_key: "snort-alert-{0}:{1}:{2}"
              pagerduty_incident_key_args:
              - "@source.host"
              - "sid"
              - "rev"
              filter:
              - bool:
                  must:
                  - term:
                      "@source.component": "snort"
          - name: clamav
            content:
              name: clamav-alert
              type: any
              index: logs-platform-*
              query_key:
              - "@source.host"
              - "event_type"
              - "signature_name"
              - "file_path"
              - "syslog_sd_params.deployment"
              - "syslog_sd_params.group"
              - "syslog_sd_params.id"
              realert:
                hours: 1
              alert_subject: "ClamAV alert on {0}:{1}/{2} (IP: {3}): file: {5} sig: {4}"
              alert_subject_args:
              - "syslog_sd_params.deployment"
              - "syslog_sd_params.group"
              - "syslog_sd_params.id"
              - "@source.host"
              - "signature_name"
              - "file_path"
              alert_text: "{0}"
              alert_text_args:
              - "@message"
              pagerduty_incident_key: "clamav-alert-{0}-{1}-{2}"
              pagerduty_incident_key_args:
              - "@source.host"
              - "signature_name"
              - "file_path"
              filter:
              - bool:
                  must:
                  - term:
                      "@source.component": "clamd"
                  - match:
                      "event_type": "ScanOnAccess"
